document.addEventListener("DOMContentLoaded",(function(){"use strict";const e={grids:{},queryVarNumbers:"load-grid",queryVarType:"grid-type",validTypes:[],init:()=>{let t=0,a=null;if(document.querySelectorAll("[data-tvbcc-number-grid]").forEach((function(o){const l=JSON.parse(o.dataset.tvbccNumberGrid),r=`tvbccGrid${t}`;null==a&&(a=o),o.id=r,l.container=o,l.gridId=r,l.isUpdating=!1,l.shareButton=o.querySelector(".share-number-grid"),l.shareButton&&l.shareButton.addEventListener("click",e.copyGridUrl),l.copycsvButton=o.querySelector(".copycsv-number-grid"),l.copycsvButton&&l.copycsvButton.addEventListener("click",e.copyGridCsv),e.validTypes.includes(l.type)||e.validTypes.push(l.type),e.grids[r]=l;o.querySelectorAll('input[type="number"]').forEach((function(t){t.addEventListener("change",e.inputChangeHandler)})),++t})),URLSearchParams){const t=window.location.search,a=new URLSearchParams(t);let o=a.get(e.queryVarType);const l=a.get(e.queryVarNumbers);if(l){e.validTypes.includes(o)||(o=e.validTypes[0]);for(const t in e.grids){const a=e.grids[t];if(a.type==o){e.loadGrid(a.container,l.split(","));break}}}}},getRowStartValueMeta:e=>{const t={isValid:!1,rowIndex:0,colIndex:0,value:0};return void 0===e.dataset.rowIdx||isNaN(t.rowIndex=parseInt(e.dataset.rowIdx))||void 0===e.dataset.keyColIdx||isNaN(t.colIndex=parseInt(e.dataset.keyColIdx))||void 0===e.dataset.keyColVal||isNaN(t.colValue=parseFloat(e.dataset.keyColVal))||(t.isValid=t.rowIndex>=0&&t.colIndex>=0),t},loadGrid:(t,a)=>{const o=t.id;e.grids[o];t.querySelectorAll("[data-row-idx]").forEach((e=>{delete e.dataset.keyColIdx,delete e.dataset.keyColVal})),t.querySelectorAll("[data-row-idx]").forEach((e=>{let t=parseInt(e.dataset.rowIdx),o=-1,l=0,r=!1;if(void 0!==a[t]){const e=a[t].split(":");2==e.length&&(isNaN(o=e[0])||(isNaN(l=parseFloat(e[1]))?o=-1:r=!0))}e.querySelectorAll('[data-col-idx] input[type="number"]').forEach((t=>{const a=t.closest("[data-col-idx]");let d=parseInt(a.dataset.colIdx);r&&d==o?(t.value=l,t.dispatchEvent(new Event("change")),e.dataset.keyColIdx=d,e.dataset.keyColVal=l):t.value=""}))}))},copyGridCsv:t=>{const a=t.target.closest("[data-tvbcc-number-grid]"),o=a.id,l=e.grids[o];let r="";a.querySelectorAll("[data-row-idx]").forEach((e=>{let t=0;e.querySelectorAll('input[type="number"]').forEach((e=>{t>0&&(r+="\t");let a="";""===e.value||isNaN(a=parseFloat(e.value))||(r+=`${a}`),++t})),r+="\n"}));let d="";if(r&&l.csvAddHeadings){let e=0;a.querySelectorAll("th[data-col-idx] .col-title").forEach((t=>{e>0&&(d+="\t"),d+=`"${t.innerText}"`,++e})),e>0&&(d+="\n")}d+=r,e.copyToClipboard(d,l.copycsvButton,l.labels.copiedCsv)},copyGridUrl:t=>{const a=t.target.closest("[data-tvbcc-number-grid]"),o=a.id,l=e.grids[o],r=[];if(a.querySelectorAll("[data-row-idx]").forEach((t=>{const a=e.getRowStartValueMeta(t);if(a.isValid){for(;r.length<a.rowIndex;)r.push("");r.push(`${a.colIndex}:${a.colValue}`)}})),r.length){let t=window.location.href.split("?")[0];t+=`?${e.queryVarNumbers}=${r.join(",")}`,l.type&&(t+=`&${e.queryVarType}=${l.type}`),e.copyToClipboard(t,l.shareButton,l.labels.copiedLink)}},copyToClipboard:(e,t,a)=>{let o=!1;if("string"!=typeof e);else if(e.length){if(navigator.clipboard&&window.isSecureContext)navigator.clipboard.writeText(e),o=!0;else if("function"==typeof document.execCommand){const t=document.createElement("textarea");t.value=e,t.style.position="absolute",t.style.left="-100px",t.style.top="0px",t.style.width="50px",document.body.prepend(t);try{t.focus(),t.select(),document.execCommand("copy"),o=!0}catch(e){}finally{t.remove()}}}else;if(o){const e=document.createElement("div");e.innerText=a,e.classList.add("grid-tooltip"),t.append(e),setTimeout((()=>{e.remove()}),2e3)}},inputChangeHandler:t=>{const a=t.target,o=a.closest("[data-tvbcc-number-grid]"),l=o.id,r=e.grids[l],d=a.closest("[data-row-idx]"),s=(parseInt(d.dataset.rowIdx),a.closest("[data-col-idx]")),i=parseInt(s.dataset.colIdx),n=parseFloat(a.value);if(isNaN(n))delete d.dataset.keyColIdx,delete d.dataset.keyColVal;else if(d.dataset.keyColIdx=i,d.dataset.keyColVal=n,r.isUpdating);else{r.isUpdating=!0;let e=null,t=null;r.decimals>3&&(e=new RegExp(".[0]{4,}"),t=new RegExp(".[9]{4,}"));let a=r.animDelay,o=i,l=n;for(let s=0;s<r.colCount-1;++s){++o,o>=r.colCount&&(o=0);const s=d.querySelector(`[data-col-idx="${o}"] input`);let i=l;const n=r.colMetas[o];switch(n.operator){case"div":i=1*l/n.operand;break;case"mul":i=1*l*n.operand;break;case"copy":i=l}const c=10**r.decimals*1;let u=Math.round(i*c)/c;const p=String(u);(e&&e.test(p)||t&&t.test(p))&&(u=Math.round(100*u)/100),r.animate&&r.animDelay>0?(setTimeout((()=>{s.value=""}),a),a+=r.animDelay,setTimeout((()=>{s.value=u,s.scrollLeft=0}),a)):(s.value=u,s.scrollLeft=0),l=i}r.isUpdating=!1}let c=0;o.querySelectorAll("[data-row-idx]").forEach((t=>{const a=e.getRowStartValueMeta(t);c+=a.isValid?1:0})),r.shareButton&&(r.shareButton.disabled=0===c),r.copycsvButton&&(r.copycsvButton.disabled=0===c)}};e.init()}));
